# DISABLED: Railway deployment moved to GitHub Pages
# To re-enable, uncomment this workflow
# name: Deploy to Railway

on:
  workflow_dispatch:  # Only manual trigger, disabled for automatic deployment
  # push:
  #   branches:
  #     - main
  #     - master
  # pull_request:
  #   branches:
  #     - main
  #     - master

env:
  NODE_VERSION: '20'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm run lint
        continue-on-error: true

      - name: Build application
        run: pnpm run build

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure Terraform S3 Backend
        working-directory: ./infrastructure
        env:
          AWS_ENDPOINT: ${{ secrets.AWS_ENDPOINT }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          TF_S3_BUCKET: ${{ secrets.TF_S3_BUCKET }}
        run: |
          # Crear backend.hcl dinÃ¡micamente si tenemos la configuraciÃ³n de MinIO
          if [ -n "$AWS_ENDPOINT" ] && [ -n "$AWS_ACCESS_KEY_ID" ] && [ -n "$AWS_SECRET_ACCESS_KEY" ] && [ -n "$TF_S3_BUCKET" ]; then
            cat > backend.hcl <<EOF
          bucket = "$TF_S3_BUCKET"
          key = "terraform.tfstate"
          region = "us-east-1"
          endpoint = "$AWS_ENDPOINT"
          access_key = "$AWS_ACCESS_KEY_ID"
          secret_key = "$AWS_SECRET_ACCESS_KEY"
          skip_credentials_validation = true
          skip_metadata_api_check = true
          skip_region_validation = true
          force_path_style = true
          EOF
            echo "âœ… Backend S3 configurado: $AWS_ENDPOINT"
          else
            echo "âš ï¸  Variables de MinIO no configuradas. El backend usarÃ¡ valores por defecto (localhost)"
            echo "ðŸ“ Para usar MinIO, configura los secretos: AWS_ENDPOINT, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY, TF_S3_BUCKET"
          fi

      - name: Terraform Init
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          # Variables para el backend S3 (si estÃ¡n configuradas)
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_ENDPOINT: ${{ secrets.AWS_ENDPOINT }}
        run: |
          # Si existe backend.hcl, Ãºsalo; si no, usa valores por defecto
          if [ -f backend.hcl ]; then
            echo "âœ… Usando backend.hcl para configuraciÃ³n S3 remota"
            terraform init -backend-config=backend.hcl || {
              echo "âŒ Error inicializando con backend S3"
              echo "ðŸ“ Verifica que:"
              echo "   1. MinIO estÃ© desplegado en Railway"
              echo "   2. Los secretos de AWS estÃ©n configurados correctamente"
              echo "   3. El bucket exista en MinIO"
              exit 1
            }
          else
            echo "âš ï¸  backend.hcl no encontrado. Usando configuraciÃ³n por defecto (localhost)"
            echo "âš ï¸  Para producciÃ³n, configura los secretos de MinIO en GitHub"
            terraform init
          fi

      - name: Terraform Validate
        working-directory: ./infrastructure
        run: |
          terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform plan \
            -var="railway_token=${{ secrets.RAILWAY_TOKEN }}" \
            -var="project_name=geny-market" \
            -var="service_name=web" \
            -var="environment=production" \
            -var="port=80" \
            -var="github_repo=${{ github.repository }}" \
            -var="github_branch=${{ github.ref_name }}" \
            -var="generate_domain=true" \
            -var="service_subdomain=web" \
            -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform apply -auto-approve tfplan
          
      - name: Terraform Output
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform output
          
      - name: Cleanup Terraform Plan
        if: always()
        working-directory: ./infrastructure
        run: |
          rm -f tfplan tfplan.*
