name: Deploy to Railway

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  TERRAFORM_VERSION: '1.6.0'

jobs:
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linter
        run: pnpm run lint
        continue-on-error: true

      - name: Build application
        run: pnpm run build

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Configure Terraform Backend
        working-directory: ./infrastructure
        env:
          TF_BACKEND_URL: ${{ secrets.TF_BACKEND_URL }}
        run: |
          # Crear backend.hcl dinÃ¡micamente si tenemos la URL del backend
          if [ -n "$TF_BACKEND_URL" ]; then
            cat > backend.hcl <<EOF
          address = "$TF_BACKEND_URL/terraform.tfstate"
          lock_address = "$TF_BACKEND_URL/terraform.tfstate/lock"
          unlock_address = "$TF_BACKEND_URL/terraform.tfstate/lock"
          lock_method = "POST"
          unlock_method = "DELETE"
          retry_max = 5
          retry_wait_min = 1
          EOF
            echo "âœ… Backend HTTP configurado: $TF_BACKEND_URL"
          else
            echo "âš ï¸  TF_BACKEND_URL no configurado."
            echo "ðŸ“ Para el primer deployment, esto es normal. El estado se guardarÃ¡ localmente."
            echo "ðŸ“ DespuÃ©s del primer deployment, configura TF_BACKEND_URL con la URL del servicio terraform-backend"
            echo "ðŸ“ Luego ejecuta: terraform init -migrate-state -backend-config=backend.hcl"
          fi

      - name: Terraform Init
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Si existe backend.hcl, Ãºsalo
          if [ -f backend.hcl ]; then
            echo "âœ… Usando backend.hcl para configuraciÃ³n remota"
            terraform init -backend-config=backend.hcl || {
              echo "âŒ Error inicializando con backend remoto"
              echo "ðŸ“ Verifica que:"
              echo "   1. El servicio terraform-backend estÃ© desplegado en Railway"
              echo "   2. El secreto TF_BACKEND_URL tenga la URL correcta"
              echo "   3. El servicio tenga un dominio pÃºblico configurado"
              exit 1
            }
          else
            echo "âŒ TF_BACKEND_URL no estÃ¡ configurado"
            echo ""
            echo "ðŸ“ Para configurar el backend:"
            echo "   1. Despliega la infraestructura manualmente primero (esto crearÃ¡ el servicio terraform-backend)"
            echo "   2. ObtÃ©n la URL del servicio terraform-backend desde Railway Dashboard"
            echo "   3. Agrega el secreto TF_BACKEND_URL en GitHub con esa URL"
            echo "   4. Ejecuta este workflow nuevamente"
            echo ""
            echo "ðŸ’¡ Alternativa: Para desarrollo local, puedes usar backend.hcl con localhost"
            exit 1
          fi

      - name: Terraform Validate
        working-directory: ./infrastructure
        run: |
          terraform validate

      - name: Terraform Plan
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform plan \
            -var="railway_token=${{ secrets.RAILWAY_TOKEN }}" \
            -var="project_name=geny-market" \
            -var="service_name=web" \
            -var="environment=production" \
            -var="port=80" \
            -var="github_repo=${{ github.repository }}" \
            -var="github_branch=${{ github.ref_name }}" \
            -var="generate_domain=true" \
            -var="service_subdomain=web" \
            -out=tfplan
        continue-on-error: true

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform apply -auto-approve tfplan
          
      - name: Terraform Output
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        working-directory: ./infrastructure
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          terraform output
          
      - name: Cleanup Terraform Plan
        if: always()
        working-directory: ./infrastructure
        run: |
          rm -f tfplan tfplan.*
